<?php 
class bprofile_model extends CI_Model {
 
	function insertServices(){
		$insertArray=array();
		$insertArray['user_business_details_id']= $this->session->userdata['business_id']; 
		if(isset($_POST['servicename']))$insertArray['name']= $_POST['servicename'];
		if(isset($_POST['price_type']))$insertArray['price_type']= $_POST['price_type'];
		if(isset($_POST['price']))$insertArray['price']= $_POST['price'];
		if(isset($_POST['length']))$insertArray['timelength']= $_POST['length'];
		if(isset($_POST['description']))$insertArray['details']= $_POST['description']; 
		if(isset($_POST['type']))$insertArray['time_type']= $_POST['type'];
		if(isset($_POST['ptime_before']))$insertArray['ptime_before']= $_POST['ptime_before']; 
		if(isset($_POST['ptime_before_type']))$insertArray['ptime_before_type']= $_POST['ptime_before_type'];
		if(isset($_POST['ptime_after']))$insertArray['ptime_after']= $_POST['ptime_after']; 
		if(isset($_POST['ptime_after_type']))$insertArray['ptime_after_type']= $_POST['ptime_after_type'];
		
		if(isset($_POST['id']) && $_POST['id']!=""){
		$this->db->update('user_business_services',$insertArray,array('id' => $_POST['id']));
		mysql_query("delete from employee_services where service_id=".$_POST['id']);
		$id = $_POST['id'];
		}else{
		$this->db->insert('user_business_services',$insertArray);
		$id=mysql_insert_id();
		}
		if(isset($_POST['staffs']))
		$assignStaff=array();
		$i=0;
		foreach($_POST['staffs'] as $val){
			$assignStaff['users_id']=$val;
			$assignStaff['business_id']=$this->session->userdata['business_id'];
			$assignStaff['service_id']=$id;
			$this->db->insert("employee_services",$assignStaff);
			$i++;
		}
		return true;
	}
	
	function getServices(){
		$sql="Select * from user_business_services where user_business_details_id =".$this->session->userdata['business_id'];
		$query=$this->db->query($sql);
		$data= $query->result();
		$i=0;
		if($data){
			foreach($data as $dataP){
				$values[$i]['id'] =$dataP->id;
				$values[$i]['name']= $dataP->name;
				$i++;
			}
			return $values;
		}
	}
		
	function getServicedetails(){
		 $val= $this->common_model->getRow("user_business_services",'id',$_GET['id']);
		 $value ='[{"name": "'.$val->name.'","id": "'.$val->id.'","type": "'.$val->price_type.'","price": "'.$val->price.'","timelength": "'.$val->timelength.'","time_type": "'.$val->time_type.'","details": "'.$val->details.'","ptime_before": "'.$val->ptime_before.'","ptime_before_type": "'.$val->ptime_before_type.'","ptime_after": "'.$val->ptime_after.'","ptime_after_type": "'.$val->ptime_after_type.'"}]';			
		return $value;
	}
	
	function getAssignedStaffs(){
		 $value= $this->common_model->getAllRows("employee_services",'service_id',$_GET['serviceid']);
         return $value;
	}
	
	function insertStaffs(){
	  $insertArray=array();
		if(isset($_POST['firstname']))$insertArray['first_name']= $_POST['firstname'];
		if(isset($_POST['lastname']))$insertArray['last_name']= $_POST['lastname'];
		if(isset($_POST['email']))$insertArray['email']= $_POST['email'];
		if(isset($_POST['phonenumber']))$insertArray['phone_number']= $_POST['phonenumber'];
		$insertArray['user_role']= 'employee';
		if(isset($_POST['email'])){
		$insertArray['status']= 'inactive';
		$insertArray['activationkey']= MD5($_POST['email'].time());
		}
		if(isset($_POST['id']) && $_POST['id']!=""){
		$this->db->update('users',$insertArray,array('id' => $_POST['id']));
		mysql_query("delete from employee_services where users_id=".$_POST['id']);
		mysql_query("delete from user_business_availability where users_id=".$_POST['id']);
		$id = $_POST['id'];
		}else{
		$this->db->insert('users',$insertArray);
		$id=mysql_insert_id();
		$insertEmployee=array();
		$insertEmployee['user_business_details_id']=$this->session->userdata['business_id']; 
		$insertEmployee['users_id']=$id; 
		$insertEmployee['employee_type']='employee'; 
		$this->db->insert('business_employees',$insertEmployee);
		}
		
		//to insert/update the staffs availability
		for($i=1;$i<=7;$i++){
				if(isset($_POST[$i])) {
				$available['user_business_details_id']= $this->session->userdata['business_id'];
				$available['users_id']=$id;
				$available['type']='employee';
				$available['weekid']= $i;
				$available['start_time']= $_POST[$i."from"];
				$available['end_time']= $_POST[$i."to"];
				if(isset($_POST['L'.$i])){
				$available['lunch_start_time']= $_POST[$i."Lfrom"];
				$available['lunch_end_time']= $_POST[$i."Lto"];
				}else{
				$available['lunch_start_time']= "0";
				$available['lunch_end_time']="0";
				}
				$this->db->insert('user_business_availability',$available);
				}
			}
		
		//to insert/update assigned services 
		if(isset($_POST['services']))
		$assignService=array();
		$i=0;
		foreach($_POST['services'] as $val){
			$assignService['users_id']=$id;
			$assignService['business_id']=$this->session->userdata['business_id'];
			$assignService['service_id']=$val;
			$this->db->insert("employee_services",$assignService);
			$i++;
		}
		
		return true;
	}
	
	function getStaffs(){
		$sql="Select * from view_business_employees where user_business_details_id =".$this->session->userdata['business_id'];
		$query=$this->db->query($sql);
		$data= $query->result();
		$i=0;
		if($data){
			foreach($data as $dataP){
				$values[$i]['id'] =$dataP->users_id;
				$values[$i]['name']= $dataP->first_name." ".$dataP->last_name;
				$i++;
			}
			return $values;
		}
	}
	
	function getStaffdetails(){
		 $val= $this->common_model->getRow("view_business_employees",'users_id',$_GET['id']);
		 $value ='[{"firstname": "'.$val->first_name.'","id": "'.$val->users_id.'","lastname": "'.$val->last_name.'","email": "'.$val->email.'","phone_number": "'.$val->phone_number.'"}]';
		 return $value;
	}
	
	function getAssignedServices(){
		 $value= $this->common_model->getAllRows("employee_services",'users_id',$_GET['staffid']);
         return $value;
	}
	
	function getAvailibility(){
		 $value= $this->common_model->getAllRows("user_business_availability",'users_id',$_GET['staffsid']);
         return $value;
	}
	
	
}
?>