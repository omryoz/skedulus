<?php
/* Manage Home Controller */
class Home extends CI_Controller {

	function __construct(){
		parent::__construct();
		$this->load->helper('form');
		$this->load->library('parser');
		$this->load->helper('url');
		$this->load->library('email');
		$this->load->model('home_model');
		$this->load->model('common_model');
		$this->data['bodyclass']='index';
		$this->load->library('form_validation');
    }
	
	public function index() {
		$this->parser->parse('include/header',$this->data);
		$this->parser->parse('general/home',$this->data);
		$this->parser->parse('include/footer',$this->data);
	}
	
	public function businesslogin(){
		$this->parser->parse('include/meta_tags',$this->data);
		$this->data['userRole']="businessSignUp";
		$this->parser->parse('general/login',$this->data);
	}
	
	public function clientlogin(){
	if(isset($_GET['checkinfo'])){
	$password= MD5($_POST['password']);
	 $where=" And password='".$password."'";
	 $values=$this->common_model->getRow("users","email",$_POST['email'],$where);
	 if($values==""){
	 $this->data['failure']="Failure";
	 $this->parser->parse('include/meta_tags',$this->data);
	$this->data['userRole']="clientlogin";
	$this->parser->parse('general/login',$this->data);
	 }else{
	 $this->parser->parse('include/header',$this->data);
	 $this->load->view('user_profile',$this->data);
	 $this->parser->parse('include/footer',$this->data);
	 }
	}else{
	$this->parser->parse('include/meta_tags',$this->data);
	$this->data['userRole']="clientlogin";
	$this->parser->parse('general/login',$this->data);
	}
	}
	
	public function businessSignUp(){
	if(isset($_GET['checkino'])){
	   $validation = array(
                    array('field' => 'firstname','class'=>'required' , 'label' => 'First name', 'rules' => 'required'),
					array('field' => 'lastname', 'label' => 'Last name', 'rules' => 'required'),
					array('field' => 'gender', 'label' => 'Gender', 'rules' => 'required'),
					array('field' => 'email', 'label' => 'Email', 'rules' => 'required|valid_email|callback_check_email'),
					array('field' => 'password', 'label' => 'Password', 'rules' => 'required'),
                );
		 $this->form_validation->set_rules($validation);
		 if ($this->form_validation->run() == TRUE) {
		 $id=$this->home_model->insertinfo();
		 $this->account_activation($id);
		 $checkinfo="sucessful";
		}
	}
	  $this->parser->parse('include/meta_tags',$this->data);
	  if(isset($checkinfo)){
	  $this->data['success']="successfull";
	  }
	  $this->data['userRole']="businessSignUp";
	  $this->load->view('general/signup',$this->data);
	}
	
	public function clientSignUp(){
	if(isset($_GET['checkino'])){
	   $validation = array(
                    array('field' => 'firstname','class'=>'required' , 'label' => 'First name', 'rules' => 'required'),
					array('field' => 'lastname', 'label' => 'Last name', 'rules' => 'required'),
					array('field' => 'gender', 'label' => 'Gender', 'rules' => 'required'),
					array('field' => 'email', 'label' => 'Email', 'rules' => 'required|valid_email|callback_check_email'),
					array('field' => 'password', 'label' => 'Password', 'rules' => 'required'),
                );
		 $this->form_validation->set_rules($validation);
		 if ($this->form_validation->run() == TRUE) {
		 $id=$this->home_model->insertinfo();
		 //$this->account_activation($id);
		 $checkinfo="clientsucessful";
		}
	}
	  $this->parser->parse('include/meta_tags',$this->data);
	  if(isset($checkinfo)){
	  $this->data['clientsuccess']="successfull";
	  }
	  $this->data['userRole']="clientSignUp";
	  $this->load->view('general/signup',$this->data);
	}
	
	
	public function account_activation($id){
	    $userdetails= $this->common_model->getRow("users","id",$id);
	    $this->data['name'] = $userdetails->first_name." ".$userdetails->last_name;
		$this->data['activation_key'] = $userdetails->activationkey;
		echo ">>".$this->data['email'] = $userdetails->email; 
		//Get email 
		$this->email->from('swathi.n@eulogik.com', 'swathi');
		$this->email->to($this->data['email']); 
		$this->email->subject('Email Test');
		$message=$this->load->view('account_activation',$this->data);
        $this->email->message($message);  		
		$this->email->send();
		echo $this->email->print_debugger();
	}
	
	
	public function check_email($email){
	  $isDuplicate=$this->common_model->getRow("users","email",$email);
	  if($isDuplicate){
		$this->form_validation->set_message('check_email', 'This email id already exist.');
			return false;
	  }else{
			return true;
		}
	
	}
	
	
	
}

?>
